# ==============================================================================
# Configuration Nginx pour ScolarTrack (Application React)
# ==============================================================================

server {
    listen 80; # Écoute les requêtes sur le port 80 (HTTP)
    listen [::]:80; # Écoute les requêtes IPv6 sur le port 80

    server_name _; # Peut être remplacé par votre nom de domaine en production

    # Définit la racine des fichiers de votre application construite
    root /usr/share/nginx/html;

    # Spécifie les fichiers d'index par défaut
    index index.html index.htm;

    # Configuration pour la compression Gzip (réduit la taille des fichiers transférés)
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss image/svg+xml font/woff2;
    gzip_disable "MSIE [1-6]\."; # Désactive gzip pour les anciens navigateurs IE

    # Gestion des en-têtes CORS (Cross-Origin Resource Sharing)
    # C'est souvent nécessaire si  l'API est sur un domaine différent
    # ou si vous avez des polices ou des ressources chargées depuis un autre domaine.
    # A décommenter et ajuster selon les besoins réels
    # add_header 'Access-Control-Allow-Origin' '*';
    # add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
    # add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
    # add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';

    # --- En-têtes de sécurité (Security Headers) ---
    # Protège contre le clickjacking. 'SAMEORIGIN' n'autorise l'affichage
    # dans une frame que si elle provient du même domaine.
    add_header X-Frame-Options "SAMEORIGIN" always;
    # Protège contre les attaques XSS (Cross-Site Scripting).
    add_header X-XSS-Protection "1; mode=block" always;
    # Empêche le navigateur de deviner le type MIME d'un fichier.
    add_header X-Content-Type-Options "nosniff" always;
    # Politique de sécurité de contenu (CSP) - à configurer avec soin.
    # Cet exemple est un point de départ. À adapter à vos besoins spécifiques.
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self';" always;
    # Cache de l'application (pour les fichiers statiques)
 
    # --- Mise en cache des assets statiques ---
    # Les fichiers avec des hashs dans leur nom (JS, CSS, polices, images) peuvent être
    # mis en cache de manière agressive par le navigateur.

    location ~* \.(?:css|js|jpg|jpeg|gif|png|ico|svg|eot|otf|ttf|woff|woff2)$ {
        expires 1y; # Les fichiers seront mis en cache par le navigateur pendant 1 an
        add_header Cache-Control "public"; # Indique que le cache peut être public (par les proxys)
        # Optionnel: Supprime la gestion des logs d'accès pour ces fichiers pour réduire le bruit
        access_log off;
        log_not_found off;
    }

    # Cache des fichiers HTML
    location ~* \.(?:html|htm)$ {
        expires -1; # Les fichiers HTML expirent immédiatement pour toujours obtenir la dernière version
        add_header Cache-Control "no-cache, no-store, must-revalidate"; # Ne pas mettre en cache
    }

    # Configuration essentielle pour les Single Page Applications (SPA) comme React
    # Tente de servir le fichier demandé directement.
    # S'il n'existe pas, tente de servir un répertoire.
    # Si cela échoue aussi, renvoie sur /index.html.
    location / {
        try_files $uri $uri/ /index.html;

         # Le fichier index.html ne doit jamais être mis en cache par le navigateur
        # pour s'assurer que les utilisateurs obtiennent toujours la dernière version de l'app.
        if ($request_uri = '/index.html') {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
    }

    # Gestion des erreurs personnalisées (optionnel)
    # Par exemple, pour renvoyer votre page 404 de React pour toutes les erreurs non gérées par try_files
    error_page 404 /index.html; # Redirige les erreurs 404 vers votre page d'accueil (React gérera le routage interne)
    # error_page 500 502 503 504 /50x.html; # Pour des pages d'erreur serveur spécifiques si on en a
    # location = /50x.html {
    #     root /usr/share/nginx/html;
    # }
    
    # Cachez la version de Nginx pour des raisons de sécurité
    server_tokens off;
}